<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
"http://www.w3.org/TR/html4/loose.dtd"/>

<html>
<head>
  <meta name="generator" content=
  "HTML Tidy for Windows (vers 25 March 2009), see www.w3.org"/>

  <title>KiCad Eeschema as GUI for ngspice, tutorial for setting up the simulation</title>
  <link rel="stylesheet" type="text/css" href="ngstyle2.css"/>
  <meta name="generator" content="screem 0.12.2"/>
  <meta name="author" content="Holger Vogt"/>
  <meta http-equiv="Content-Type" content=
  "text/html; charset=us-ascii"/>
  <meta http-equiv="Content-Script-Type" content="text/javascript"/>
  <meta http-equiv="Content-Style-Type" content="text/css"/>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content=
  "This tutorial describes how to set up Eeschema for simulating analog or digital circuits."/>
  <meta name="keywords" content=
  "tutorial, ngspice, KiCad, Eeschema, circuit simulation, EDA, simulator, electronics, semiconductor"/>
  </head>

<body>
  <div id="paper">
    <div id="header">
      <pframe>
        <pic1><img src="./images/nglogo.jpg" alt="NGSPICE"></pic1>
        <pic2><img src="./images/ngtext2.jpg" alt=
        "Mixed mode - mixed level circuit simulator - based on Berkeley&#39;s Spice3f5"></pic2>
        <pic3><a href="http://sourceforge.net/projects/ngspice"><img src=
        "./images/ngsumD.jpg" alt="Developer Pages" border="0"></a></pic3>
      </pframe>
    </div>

    <div id="navcontainer">
      <ul id="navlist">
        <li><a href="./index.html">Home</a></li>

        <li><a href="./news.html">News</a></li>
        
        <li><a href="./screens.html">Screenshots</a></li>

        <li><a href="./download.html">Download</a></li>

        <li><a href="./docs.html">Documentation</a></li>

        <li><a href="./extras.html">Extras/Options</a></li>

        <li><a href="./applic.html">Applications</a></li>

        <li><a href="./devel.html">Development</a></li>

        <li><a href="./resources.html">Simulation Environments</a></li>

        <li><a href="./recipes.html">Recipes</a></li>

      </ul>
    </div>

    <div id="left">
      <div id="context">
        <div id="contextcontent">
          <p class="contextual title">XSPICE in ngspice</p>

          <div id="menucontainer">
            <ul id="menulist">
              <li><a href="./xspice.html">What is XSPICE ?</a></li>

              <li><a href="./xspicehowto.html">XSPICE and ngspice
              HOWTO</a></li>
            </ul>

            <p class="contextual title">ngspice as shared library</p>

            <ul id="menulist">
              <li><a href="./shared.html">Short Intro</a></li>
              <li><a href="./parallel.html">ngspice parallel</a></li>
            </ul>

            <p class="contextual title">CUSPICE</p>
            <ul id="menulist">
              <li><a href="./cuspice.html">CUSPICE Intro</a></li>
            </ul>

            <p class="contextual title">ADMS for ngspice</p>

            <ul id="menulist">
              <li><a href="./adms.html">What is ADMS ?</a></li>

              <li><a href="./admshowto.html">ADMS and ngspice
              HOWTO</a></li>
            </ul>

            <p class="contextual title">GSS-TCAD</p>

            <ul id="menulist">
              <li><a href="./gss.html">GSS</a></li>
            </ul>

            <p class="contextual title">TCLspice</p>

            <ul id="menulist">
              <li><a href="./tclspice.html">What is TCLspice
              ?</a></li>

              <li><a href="./tclusers.html">TCLspice users
              manual</a></li>

              <li><a href="./tclexamples.html">TCLspice by
              examples</a></li>

              <li><a href="./tclnotes.html">Designer's
              note</a></li>
            </ul>
          </div>
        </div>
      </div>

      <div id="main">
        <div id="maincontent">
<p class="header">Tutorial: ngspice simulation in KiCad/Eeschema</p>
<ol start="0"> 
  <li> <a href="#intro">Introduction</a></li>
  <li> <a href="#setting">Setting up eeschema - ngspice</a></li>  
  <li> <a href="#rc">Circuit with Passive Elements</a></li> 
  <li> <a href="#BipAmp">Bipolar Amplifier</a></li> 
  <li> <a href="#OpAmp">Inverting Amplifier with OpAmp</a></li>
  <li> <a href="#digi">Digital Simulation</a></li>  
</ol> 
<div id="intro"></div>
<p class="header">Introduction</p>
<p class="justified"><a href="http://kicad-pcb.org/">KiCad/Eeschema</a>
is a very nice GUI that may
ideally be used in coopration with ngspice to allow schematic entry of
eletronic circuits, simulation, and plotting of the results.</p>

<p class="justified">All experiments described here require using at
least KiCad Version 5, and have been done with a MS Windows nightly.
This tutorial reflects my first steps using the Eeschema GUI. Most
items covered should be similar with KiCad/ngspice under LINUX.
For more detailed information on the Eeschema-ngspice interface and its usage,
please check out the 
<a href="http://docs.kicad-pcb.org/master/en/eeschema.html#simulator">KiCad/Eeschema manual</a>.</p>

<p class="justified">Three example circuits are presented in the following.
The first one relies exclusively on symbols from a KiCad library. This
circuit comprises of only passive elements that may be simulated immediately.
The second circuit is an amplifier with a bipolar npn transistor that
requires specific model parameters from an external source for the
built-in transistor model. The third circuit is an
OpAmp amplifier that relies on an external OpAmp model for simulation.</p>
<br>
<br>
<div id="setting"></div>
<p class="header">1) Setting up Eeschema and ngspice</p>

Highly recommended: Install the KiCad 5.0 release version from 
<a href="http://kicad-pcb.org/download/">http://kicad-pcb.org/download/</a>.

<p class="justified">The following actions were necessary when adding a
<a href="http://downloads.kicad-pcb.org/windows/nightly/">Windows nightly</a>
overwriting an older KiCad installation: Delete file sym-lib-table in
C:\Users\yourname\AppData\Roaming\kicad\
(if there is any). It may be left over from a previous installation
and may contain incomplete data on symbol libraries, or none at all.</p>

<p class="justified">Start eeschema.</p>

<p class="justified">Because sym-lib-table is missing, a window pops up.
Select 'copy default global symbol library table', then 'ok'. 
A new file sym-lib-table is copied to the above mentioned directory. 
Now all symbol libraries from c:\Program Files\KiCad\share\kicad\library
are available in the library browser.
The library folder has been set automatically by eeschema by
setting the environmental variable KICAD_SYMBOL_DIR.</p>

<p class="justified">You may view the symbol libraries by selecting
eeschema -> Preferences -> Manage Symbol Libraries</p>

<br>

<p class="justified">Ngspice-30 reads PSPICE device libs. These are often provided by the semiconductor device manufacturers for design support. Internally ngspice translates the PSPICE syntax to ngspice before simulating. No more manual tweaking of the library description is required (hopefully).

<p class="justified">How to make use of ngspice-30 in KiCad (instead of ngspice-26 delivered with KiCad 5.0)?</p>
<p class="justified">If you are on MS Windows, do the following:</p>
<p class="justified">After installing <a href="http://kicad-pcb.org/download/">KiCad 5.0</a>,
download the ngspice dll available in 
<a href="https://sourceforge.net/projects/ngspice/files/ng-spice-rework/30/ngspice-30_dll_64.zip/download">
ngspice-30_dll_64.zip</a>.</p>
<p class="justified">Copy msys-ngspice-0.dll from folder Spice64_dll\dll-mingw\ of the zip file into Programs\KiCad\bin. Within the bin folder remane libngspice-0.dll to libngspice-0-orig.dll. Now rename msys-ngspice-0.dll to libngspice-0.dll.</p>
<p class="justified">Put a text file named .spiceinit into your user directory (C:\users\'your name', found also in
environmental variable USERPROFILE). Add the two lines
<pre>
<code>
* user provided init file
set ngbehavior=ps
</code>
</pre>
to .spiceinit. If the file name .spiceinit does not work for you, use the alternative file name spice.rc . And that's it!</p>

<p class="justified">If you are using LINUX, please check if your distribution already
offers the ngspice-30 shared library. If not, you may need to download 
<a href="https://sourceforge.net/projects/ngspice/files/ng-spice-rework/30/ngspice-30.tar.gz/download">ngspice-30.tar.gz</a>
and compile the shared library with
<pre>
<code>
./configure --with-ngshared --enable-xspice --enable-cider --enable-openmp --disable-debug CFLAGS="-m64 -O2" LDFLAGS="-m64 -s"
make -j8
sudo make install
</code>
</pre>
</p>
<p class="justified">Put the text file named .spiceinit into your home/username directory (found also in
environmental variable HOME). In admin mode, it may be the root 
directory. Add the two lines as noted above to the file. As an example, some details for Ubuntu are reported by
<a href="https://forum.kicad.info/t/ngspice-28-for-kicad/10968/19">mifi</a>. Please check
also chapt. 32.1 of the
<a href="https://sourceforge.net/projects/ngspice/files/ng-spice-rework/30/ngspice-30-manual.pdf/download">ngspice manual</a>
for prerequisites and procedures for compiling ngspice-30.</p>
<p class="justified">MacOS users may need to do the same. We will check 
if a compiled shared library can be made available with ngspice-31.</p>
<br>
<br>
<div id="rc"></div>
<p class="header">2) Circuit with passive elements</p>

<p class="justified">The first example is a simple rc ladder, and we want to
do an ac simulation.</p>

<p class="justified">eeschema -> File -> new</p>
<p class="justified">Save as rcrc.sch.</p>
<p class="justified">As a non-admin user you may not be allowed to store the
file rcrc.sch in the Program Files/Kicad directory, but you may choose any
other place accessible to you, e.g. the recommended personal folder.</p>

<p class="justified">Select and interconnect the components.</p>

<p class="justified">The 'place symbol' pointer is already open.
If not, select the appropriate button from the right column.</p>

<p class="justified">Clicking the button on the empty drawing field will
open the 'Choose Symbol' window. For this example we select the 'pspice'
library, and select and interconnect the R, C, 0, and VSOURCE symbols (see Fig. 1).
Ground (0) is required because ngspice references all voltages to a ground pin.
VSOURCE is required to deliver the input signal, and we the may view the 'out'
signal after simulation.</p>
          <div id="topimage"><img src="./kicad-images/Fig1.jpg" alt=
          "RC circuit w/o data" width="100%" height="100%"></div>
          Fig. 1
<p class="justified">Next we have to add names and values to the symbols,
by clicking onto each symbol. With R and C this is straightforward: R? is
the name to become R1 etc, R is the value to become 1k etc.
VSOURCE is special because it has to deliver the ngspice input. For an ac
simulation we don't have dc, and ac is our reference set to 1, so we replace
VSOURCE by 'dc 0 ac 1'.</p>

<p class="justified">Finally we have to tell ngspice what to simulate.
This might require having a look at the ngspice manual, chapt. 15.3.1.
We want an ac ranging from 1 Hz to 100 kHz with 10 points
per decade. A simple and comfortable way to tell this to the simulator
is just placing
a text line '.ac dec 10 1 100k' into our eeschema drawing window.
Fig.2 now shows the complete input.</p>
          <div id="topimage"><img src="./kicad-images/Fig2.jpg" alt=
          "RC circuit with data" width="100%" height="100%"></div>
Fig. 2        
<p class="justified">And off you go with Eeschema -> Tools -> Simulator</p>
<p class="justified">The simulator window pops up. Because everything
is prepared, you just hit the 'Run Simulation' button. An empty plot
window pops up. Go for 'Add Signals' -> V(out), and you see gain and
phase of the output, if the input was 1 (Fig.3). The scaling of the
plot window is not yet ideal, the x-axis lable frequency is partially hidden.</p>
          <div id="topimage"><img src="./kicad-images/Fig3.jpg" alt=
          "RC gain/phase of ac simulation" width="100%" height="100%"></div>
Fig. 3         
<p class="justified">As a next test we are interested in a transient simulation. All signals
shall now be computed versus time.</p>

<p class="justified">First we have to change the input voltage signal. A step voltage from 0 to 5 V is intended.
This will be available (see ngspice manual chapt. 4.1.1) with the PULSE source. 'dc 0 ac 1' is to be
replaced by 'PULSE (0 5 1u 1u 1u 1 1)'. The input voltage rises from 0 to 5 V after a
delay of 1 us. Pulse width and repitition time are 1s and thus far beyond the simulation time
of 100 ms. So within our simulation time we will see only the rising edge of the input signal.
The simulation command now is set to '.tran 1u 100m'. The ouput (V(out) plotted
versus time) does show the expected behavior, rising from 0 to 5 V, and is shown in Fig.4.</p>
          <div id="topimage"><img src="./kicad-images/Fig4.jpg" alt=
          "RC transient output" width="100%" height="100%"></div>
Fig. 4
<br>
<br>
<div id="BipAmp"></div>
<p class="header">3) Bipolar amplifier</p>
<p class="justified">The second example is a bipolar amplifier. Again we use the symbols from the pspice library,
except for the transistor stemming from library Transistor_BJT. Two resistors R1, R2 determine
the base current, R3 is the dc load resistor. RLoad is required because ngspice will not
accept a capacitor that does not have a dc connection at each terminal.</p>
<p class="justified">Even with all data assembled
as shown, the circuit is not complete. The transistor Q1 will need more data for simulation. The bipolar
transistor model (equations to calculate currents as function of terminal voltages) is
hard-coded in ngspice. This model however requires model parameters to make these calculations
specific for the transistor that was selected (BC546). These data are not delivered with KiCad.
They are device manufacturer specific and may be obtained from their web sites or from other sites
(here e.g. from <a href="https://www.electronicspoint.com/threads/bc549c-spice-model.37724/">BC546 model parameters</a> ).
The model parameters are
organised in a single line starting with '.model BC546 npn (...)'. Put
this line into a file BC546.lib. Double click onto the BC546 symbol. The 'Symbol Properties'
window pops up. Select 'Edit Spice Model'. In the 'Spice Model Editor' select 'Select File'
and search for  BC546.lib. Its contents (the .model line) will show up in the window (Fig.5). </p>
          <div id="topimage"><img src="./kicad-images/Fig5.jpg" alt=
          "Edit the ngspice model" width="100%" height="100%"></div>
          Fig. 5
<br>
<p class="justified">Fig. 6 is the scheme ready for ac simulation, Fig. 7 for transient simulation. </p>
          <div id="topimage"><img src="./kicad-images/Fig6.jpg" alt=
          "Amplifier circuit diagram" width="100%" height="100%"></div>
<p class="justified"> Fig. 6 </p>
          <div id="topimage"><img src="./kicad-images/Fig7.jpg" alt=
          "Amplifier circuit diagram" width="100%" height="100%"></div>
          Fig. 7
<p class="justified">Here a
sinusoidal voltage source is used (see ngspice manual chapt. 4.1.2).
The output plotted is V(out) and V(in) versus time (see Fig. 8). </p>
          <div id="topimage"><img src="./kicad-images/Fig8.jpg" alt=
          "Amplifier outout versus input" width="100%" height="100%"></div>
          Fig. 8
<br>
<p class="justified">This amplifier strongly relies on the proper selection of the value of R1. The
'Spice Simulator' window offers a button 'Tune'. Select 'Tune', click onto R1 in the circuit
diagram and then go back to the 'Spice Simulator' window. A slider has opened to change R1. 
After each change the simulation is proceeding immediately, current V(in) and V(out) are
shown.</p>
<table style="text-align: left; width: 787px; height: 90px;" border="0" cellpadding="2" cellspacing="2">
  <tbody>
    <tr> 
          <td style="vertical-align: top;"><img src="./kicad-images/tune1.jpg" alt=
          "OpAmp circuit" width="100%" height=auto></td>
           <td style="vertical-align: top;"><img src="./kicad-images/tune2.jpg" alt=
          "OpAmp circuit" width="100%" height=auto></td>
           <td style="vertical-align: top;"><img src="./kicad-images/tune3.jpg" alt=
          "OpAmp circuit" width="100%" height=auto></td>
    </tr>
  </tbody>
</table>
<p class="justified">On the left, that's the ideal situation with R1=68k. In the middle with R1=78k, the
amplification has decreased considerably (watch the y scale and the ratio of V(out) versus V(in)). On the
right with R1=63k, the signal is grossly distorted and the amplification is reduced again.</p>
<br>
<br>
<div id="OpAmp"></div>
<p class="header">4) Inverting amplifier with OpAmp</p>
<p class="justified">The next example presents a simple inverting amplifier using an Operational Amplifier.
The circuit is shown in Fig. 9. The LF356 has been chosen by chance. The resistor ratio
R2/R1 = 100 sets the amplification. Symmetric power supplies are available as well as the
input voltage source.</p>
          <div id="topimage"><img src="./kicad-images/Fig9.jpg" alt=
          "OpAmp circuit" width="100%" height="100%"></div>
          Fig. 12
<p class="justified"> There is no model for OpAmps delivered with ngspice. Nor does KiCad
deliver such a model. So you have to search in the web for a device maker's model, e.g. from the
<a href="http://www.ti.com/lit/zip/snom255">TI web pages</a> as LF356.mod.</p>
<p class="justified">If you have a look at LF356.mod, there you find the circuit assembled in a subcircuit (.subckt
line) with name LF356 and 5 connecting nodes. Obviously the two offset cancelation nodes
1 and 5 of the KiCad symbol are not served by this model.</p>

<p class="justified">How to add the ngspice model? Double click on the LF356 symbol in the circuit drawing.
The 'Symbol Properties' window opens. Call 'Edit Spice Model'. Select 'Model' -> 'File Select'.
Enter path/name of LF356.mod. Select 'Type' -> 'Subcircuit'. The description of the subcircuit is shown
in the window.</p>

<p class="justified">Another issue has to be addressed: The pin numbering of the model description does not
comply with the pin numbering of the KiCad LF356 symbol U1. The KiCad symbol/pin pairs are
(in)-/2 (in)+/3 V+/7 V-/4 out/6. The model requires a sequence
<ul>
<li>non-inverting input</li>
<li>inverting input</li>
<li>positive power supply</li>
<li>negative power supply</li>
<li>output</li>
</ul>
<p class="justified">as described in the model file. The KiCad
pins have to be ordered into this sequence, i.e. 3 2 7 4 6, and entered into the
'Alternate node sequence' field. Don't forget to set the check box, otherwise the field
entry is discarded. Fig. 10 shows the final settings.</p>
          <div id="topimage"><img src="./kicad-images/Fig10.jpg" alt=
          "OpAmp modl setting" width="100%" height="100%"></div>
          Fig. 13
<p class="justified">The simulation setting
'.dc Vin -0.5 0.5 0.1' results in a linear Vout with a negative slope of -100. The
simulation setting '.ac dec 10 100 1000k' yields the amplification degrading with
increasing frequency.</p>
<br>
<br>
<div id="digi"></div>
<p class="header">5) Digital Simulation</p>
<p class="justified">If you have only a few digital gates, you may pursue an analog simulation with digital
gates described at transistor level. Currently I am not aware of calibrated fully functional and open
source gate models. The semiconductor manufacturer Nexperia's models are not fully
functional gates and may be used only for delay calculations. However, bobc started
generating a basic <a href="https://github.com/bobc/kicad-simulation-examples">library</a>
at transistor level.</p>

<p class="justified">There are some other simulation libs available for
download, unfortunately only for Orcad or LTSPICE, both not compatible with ngspice.
The gates comprise of lumped elements like special switches (e.g. A elements in LTSPICE,
U elements in Orcad/PSPICE) that mimic the gate behavior like delay time, input levels 
and output drive capability. This behavioral simulation offers higher simulation speed
compared to transistor level gates.</p>

<p class="justified">ngspice includes XSPICE that presents true digital event simulation capability, the
fastest method so far. This is not (yet?) supported by KiCad, and you would need
again a library reflecting actual circuit data.</p>

<p class="justified">Even if not very advanced and complete, let's start something. The symbol
library (see Tools->Symbol Library Editor) is 74xx, and we choose the 74HC variant. Now we need
a corresponding ngspice library. There is none available, so I started a behavioral lib
<a href="http://ngspice.sourceforge.net/experimental/74HCng.lib"><strong>74HCng.lib</strong></a>,
based on the LTSPICE lib, replacing the A devices by XSPICE logic. Each 74xx gate has an analog 
input/output interface, with the event-based logic in between. Only very few gates are there
right now, just for testing the basics. </p>
          <div id="topimage"><img src="./kicad-images/Fig11.jpg" alt=
          "Half Adder" width="100%" height="100%"></div>
          Fig. 14
<p class="justified">There are two input sources (voltage sources emitting suitable pulses), 
three gates U1A U2A U3B making the half adder, and two load ballast gates U4A, U5A. Then we
have the five power lines (VCC and ground each) for each gate. Two obtain this schematic,
the same procedure, as described in the previous chapter, applies: Get the symbols from
the 'pspce' and '74xx' libraries. Draw the wiring. Add a suitable pulse form to the VSOURCEs.
You may consult the ngspice manual, chapter 4.1.1 for an explanation. Double click on each
symbol to open the 'symbol Properties' window, select 'Edit Spice Model', enter the
simulation library name and path, the gate's model (e.g. 74HC00), and the 'Type Subcircuit'.
Don't forget setting the proper pin sequence, e.g. 1 2 3 14 7.
Add the simulation command. We want a transient simulation, so we enter '.tran 1n 4u'
into a text box.</p>
<p class="justified">Some pecularities become immediately obvious. The two load ballast
gates are required, otherwise the previous gate's output is named 'NC001', i.e. not connected
and cannot be used (e.g. plotted), even if you have given a tag to them. 
The 74HC00 is a two input NAND gate * 4, however
we have defined U2 ... U5, that is 4 different units (ICs). Normally you would design with 
a single IC offering U2A ... U2D and U2E (power). Eeschema then asks for a NAND gate model 
with 4*3+2 pins. Our simulation model in the 74HCng.lib has only 3 + 2 pins (in1 in2 out vcc gnd). 
This is a start, but there is still some improvement required in Eeschema.</p>

<p class="justified">So digital simulation still will need some effort to become really useful in KiCad/ngspice.</p>


        </div>
      </div>
    </div>

    <div id="footer">
        <pframe>
          <pic1><a href="http://sourceforge.net"><img src=
          "http://sourceforge.net/sflogo.php?group_id=38962&amp;type=1" alt=
          "SourceForge.net Logo" border="0" height="31" width="88"></a></pic1>
          <pic2>All text is available under the terms of the <a class=
          "internal" href="http://www.gnu.org/licenses/fdl.html">GNU Free
          Documentation License</a></pic2>
          <pic3><img src="./images/spice.jpg" alt=""></pic3>
        </pframe>
    </div>
  </div>
</body>
</html>
